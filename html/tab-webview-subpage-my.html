<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>Hello MUI</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">

		<link rel="stylesheet" href="../css/mui.min.css">
		<style>
			html,
			body {
				background-color: #efeff4;
			}
			.mui-views,
			.mui-view,
			.mui-pages,
			.mui-page,
			.mui-page-content {
				position: absolute;
				left: 0;
				right: 0;
				top: 0;
				bottom: 0;
				width: 100%;
				height: 100%;
				background-color: #efeff4;
			}
			.mui-pages {
				top: 46px;
				height: auto;
			}
			.mui-scroll-wrapper{
				background-image: url(../img/myPage_back.jpg);
				background-repeat: no-repeat;
				background-position: center bottom;
				background-color: #F5F5F5;
			}
			.mui-scroll-wrapper
			 {
				background-color: #F5F5F5;
			}
			.mui-scroll{
				opacity: 0.9;
			}
			.mui-page.mui-transitioning {
				-webkit-transition: -webkit-transform 300ms ease;
				transition: transform 300ms ease;
			}
			.mui-page-left {
				-webkit-transform: translate3d(0, 0, 0);
				transform: translate3d(0, 0, 0);
			}
			.mui-ios .mui-page-left {
				-webkit-transform: translate3d(-20%, 0, 0);
				transform: translate3d(-20%, 0, 0);
			}
			.mui-navbar {
				position: fixed;
				right: 0;
				left: 0;
				z-index: 10;
				height: 44px;
				background-color: #f7f7f8;
			}
			.mui-navbar .mui-bar {
				position: absolute;
				background: transparent;
				text-align: center;
			}
			.mui-android .mui-navbar-inner.mui-navbar-left {
				opacity: 0;
			}
			.mui-ios .mui-navbar-left .mui-left,
			.mui-ios .mui-navbar-left .mui-center,
			.mui-ios .mui-navbar-left .mui-right {
				opacity: 0;
			}
			.mui-navbar .mui-btn-nav {
				-webkit-transition: none;
				transition: none;
				-webkit-transition-duration: .0s;
				transition-duration: .0s;
			}
			.mui-navbar .mui-bar .mui-title {
				display: inline-block;
				width: auto;
			}
			.mui-page-shadow {
				position: absolute;
				right: 100%;
				top: 0;
				width: 16px;
				height: 100%;
				z-index: -1;
				content: '';
			}
			.mui-page-shadow {
				background: -webkit-linear-gradient(left, rgba(0, 0, 0, 0) 0, rgba(0, 0, 0, 0) 10%, rgba(0, 0, 0, .01) 50%, rgba(0, 0, 0, .2) 100%);
				background: linear-gradient(to right, rgba(0, 0, 0, 0) 0, rgba(0, 0, 0, 0) 10%, rgba(0, 0, 0, .01) 50%, rgba(0, 0, 0, .2) 100%);
			}
			.mui-navbar-inner.mui-transitioning,
			.mui-navbar-inner .mui-transitioning {
				-webkit-transition: opacity 300ms ease, -webkit-transform 300ms ease;
				transition: opacity 300ms ease, transform 300ms ease;
			}
			.mui-page {
				display: none;
			}
			.mui-pages .mui-page {
				display: block;
			}
			.mui-page .mui-table-view:first-child {
				margin-top: 15px;
			}
			.mui-page .mui-table-view:last-child {
				margin-bottom: 30px;
			}
			.mui-table-view {
				margin-top: 20px;
			}
			
			.mui-table-view span.mui-pull-right {
				color: #999;
			}
			.mui-table-view-divider {
				background-color: #efeff4;
				font-size: 14px;
			}
			.mui-table-view-divider:before,
			.mui-table-view-divider:after {
				height: 0;
			}
			.head {
				height: 40px;
			}
			#head {
				line-height: 40px;
			}
			.head-img {
				width: 40px;
				height: 40px;
			}
			#head-img1 {
				position: absolute;
				bottom: 10px;
				right: 40px;
				width: 40px;
				height: 40px;
			}
			.rightInput{
				border: none;
				text-align: right;
				width: 75%;
			}
			.update {
				font-style: normal;
				color: #999999;
				margin-right: -25px;
				font-size: 15px
			}
			.mui-fullscreen {
				position: fixed;
				z-index: 20;
				background-color: #000;
			}
			.mui-ios .mui-navbar .mui-bar .mui-title {
				position: static;
			}
			/*问题反馈在setting页面单独的css*/
			#feedback .mui-popover{
				position: fixed;
			}
			#feedback .mui-table-view:last-child {
			    margin-bottom: 0px;
			}
			#feedback .mui-table-view:first-child {
			    margin-top: 0px;
			}
			
			.mui-plus.mui-plus-stream .mui-stream-hidden{
				display: none !important;
			}
			
			/*问题反馈在setting页面单独的css==end*/
			.hasPhone{
				display: none;
			}
			
		</style>
	</head>

	<body class="mui-fullscreen">
		<!--页面主结构开始-->
		<div id="app" class="mui-views">
			<div class="mui-view">
				<div class="mui-navbar">
				</div>
				<div class="mui-pages">
				</div>
			</div>
		</div>
		<!--页面主结构结束-->
		<!--单页面开始-->
		<div id="setting" class="mui-page">
			<!--页面标题栏开始-->
			<div class="mui-navbar-inner mui-bar mui-bar-nav">
				<button type="button" class="mui-left mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left">
					<span class="mui-icon mui-icon-left-nav"></span>
				</button>
				<h1 class="mui-center mui-title">个人中心</h1>
			</div>
			<!--页面标题栏结束-->
			<!--页面主内容区开始-->
			<div class="mui-page-content">
				<div class="mui-scroll-wrapper">
					<div class="mui-scroll">
						<ul class="mui-table-view mui-table-view-chevron">
							<li class="mui-table-view-cell mui-media">
								<a>
									<img class="mui-media-object mui-pull-left head-img" id="head-img" src="">
									<div class="mui-media-body">
										人人社区
										<p class='mui-ellipsis'>
											<span id="user-name"></span>
										</p>
									</div>
								</a>
							</li>
						</ul>
						<ul class="mui-table-view mui-table-view-chevron isLoggedIn">
							<li class="mui-table-view-cell">
								<a href="#account" class="mui-navigate-right" id="aidFileShowBtn">急救档案</a>
							</li>
						</ul>
						<ul class="mui-table-view mui-table-view-chevron isLoggedIn">
							<li class="mui-table-view-cell">
								<a href="#contact" class="mui-navigate-right" id="contactShowBtn">紧急联系人</a>
							</li>
						</ul>
						<ul class="mui-table-view mui-table-view-chevron">
							<li class="mui-table-view-cell">
								<a href="#about" class="mui-navigate-right">关于人人社区 <i class="mui-pull-right update">V1.1.0</i></a>
							</li>
						</ul>
						<ul class="mui-table-view">
							<li class="mui-table-view-cell" style="text-align: center;">
								<a href="#login" id="settingBtn">登录</a>
							</li>
						</ul>
					</div>
				</div>
			</div>
			<!--页面主内容区结束-->
		</div>
		<!--单页面结束-->
		<!-- 注册页面 -->
		<div id="regist" class="mui-page">
			<div class="mui-navbar-inner mui-bar mui-bar-nav">
				<button type="button" class="mui-left mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left">
					<span class="mui-icon mui-icon-left-nav"></span>
				</button>
				<h1 class="mui-center mui-title">注册</h1>
			</div>
			<div class="mui-page-content">
				<div class="mui-scroll-wrapper">
					<div class="mui-scroll">
						<ul class="mui-table-view">
							<li class="mui-table-view-cell">
								<a id="head-reg" class="mui-navigate-right head-pic">头像
								<span class="mui-pull-right head">
									<img class="head-img mui-action-preview" id="head-img2" src=""/>
								</span>
							</a>
							</li>
							<li class="mui-table-view-cell">
								<a>帐号<input id="regAccount" class="mui-pull-right rightInput" maxlength="10" placeholder="请输入帐号"></a>
							</li>
							<li class="mui-table-view-cell">
								<a>密码<input id="regPassword" class="mui-pull-right rightInput" maxlength="10" placeholder="请输入3位及以上密码" type="password"></a>
							</li>
							<li class="mui-table-view-cell">
								<a>确认密码<input id="regConfirmPassword" class="mui-pull-right rightInput" maxlength="10" placeholder="请输入确认密码" type="password"></a>
							</li>
						</ul>
						<ul class="mui-table-view">
							<li class="mui-table-view-cell">
								<a>手机号<input  id="regPhone" class="mui-pull-right rightInput" maxlength="11" placeholder="请输入11位手机号" type="number"></a>
							</li>
						</ul>
						<ul class="mui-table-view">
							<li class="mui-table-view-cell mui-btn-primary" style="text-align: center;">
								<a href="#" id="regBtn">注册</a>
							</li>
						</ul>
					</div>
				</div>
			</div>
		</div>
		
		<!-- 登录页面 -->
		<div id="login" class="mui-page">
			<div class="mui-navbar-inner mui-bar mui-bar-nav">
				<button type="button" class="mui-left mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left">
					<span class="mui-icon mui-icon-left-nav"></span>
				</button>
				<h1 class="mui-center mui-title">登录</h1>
			</div>
			<div class="mui-page-content">
				<div class="mui-scroll-wrapper">
					<div class="mui-scroll">
						<ul class="mui-table-view">
							<li class="mui-table-view-cell">
								<a>帐号<input id="loginAccount" class="mui-pull-right rightInput" maxlength="10" placeholder="请输入帐号"></a>
							</li>
							<li class="mui-table-view-cell">
								<a>密码<input id="loginPassword" class="mui-pull-right rightInput" maxlength="10" placeholder="请输入密码" type="password"></a>
							</li>
						</ul>
						<ul class="mui-table-view">
							<li class="mui-table-view-cell">
								自动登录
								<div id="autoLogin" class="mui-switch">
									<div class="mui-switch-handle"></div>
								</div>
							</li>
						</ul>
						<ul class="mui-table-view">
							<li class="mui-table-view-cell  mui-btn-primary" style="text-align: center;border-radius: 3px;">
								<a href="#" id="loginBtn">登录</a>
							</li>
							
						</ul>
						<ul class="mui-table-view">
							<li style="display: block;padding: 10px 0; text-align: center;">
								<a href="#regist" id="registShowBtn">注册账号</a> 
								<span class="spliter"> | </span> 
								<a href='#forgetPassword' id="forgetShowBtn">忘记密码</a>
							</li>
						</ul>
					</div>
				</div>
			</div>
		</div>
		
		<!-- 忘记密码页面 -->
		<div id="forgetPassword" class="mui-page">
			<div class="mui-navbar-inner mui-bar mui-bar-nav">
				<button type="button" class="mui-left mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left">
					<span class="mui-icon mui-icon-left-nav"></span>
				</button>
				<h1 class="mui-center mui-title">找回密码</h1>
			</div>
			<div class="mui-page-content">
				<div class="mui-scroll-wrapper">
					<div class="mui-scroll">
						<ul class="mui-table-view noPhone">
							<li class="mui-table-view-cell">
								<a>帐号<input id="forgetPasswordAccount" class="mui-pull-right rightInput" maxlength="16" placeholder="请输入您的注册帐号"></a>
							</li>
						</ul>
						
						<ul class="mui-table-view hasPhone">
							<button type="button" class="mui-btn mui-btn-primary" style="height: 40px;" id="forgetSendMessge" data-loading-text = "正发送至您的手机" data-loading-icon-position="left">获取短信验证码</button>
							<li class="mui-table-view-cell">
								<a>验证码<input  id="forgetRegCode" class="mui-pull-right rightInput" maxlength="8" placeholder="请输入短信验证码" type="number"></a>
							</li>
						</ul>
						<ul class="mui-table-view hasPhone">
							<li class="mui-table-view-cell">
								<a>新密码<input  id="forgetNewPassword" class="mui-pull-right rightInput" maxlength="11" placeholder="请输入您的新密码" type="number"></a>
							</li>
						</ul>
						<ul class="mui-table-view">
							<li class="mui-table-view-cell mui-btn-primary" style="text-align: center;">
								<a href="#" id="forgetPasswordBtn">找回密码</a>
							</li>
						</ul>
					</div>
				</div>
			</div>
		</div>
		
		<!-- 急救档案页面 -->
		<div id="account" class="mui-page">
			<div class="mui-navbar-inner mui-bar mui-bar-nav">
				<button type="button" class="mui-left mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left">
					<span class="mui-icon mui-icon-left-nav"></span>个人中心
				</button>
				<h1 class="mui-center mui-title">急救档案</h1>
			</div>
			<div class="mui-page-content">
				<div class="mui-scroll-wrapper">
					<div class="mui-scroll">
						<ul class="mui-table-view">
							<li class="mui-table-view-cell">
								<a id="head-aid" class="mui-navigate-right head-pic">照片
								<span class="mui-pull-right head">
									<img class="head-img mui-action-preview" id="head-img1" src=""/>
								</span>
							</a>
							</li>
							<li class="mui-table-view-cell">
								<a>姓名<input id="aidName" class="mui-pull-right rightInput" maxlength="6" placeholder="请输入真实姓名"></a>
							</li>
						</ul>
						<ul class="mui-table-view">
							<!-- <li class="mui-table-view-cell">
								<a>家庭住址</a>
							</li> -->
							<li class="mui-table-view-cell">
								<a style="font-size: 14px;">家庭住址</a>
								<textarea id="aidAddress" rows="3" placeholder="请输入您的家庭住址"></textarea>
								<a style="font-size: 14px;">既往病例</a>
								<textarea id="aidCase" rows="3" placeholder="请输入您的病例"></textarea>
							</li>
						</ul>
						<ul class="mui-table-view">
							<li class="mui-table-view-cell mui-btn-primary" style="text-align: center;border-radius: 3px;">
								<a href="#" id="aidFileBtn">保存</a>
							</li>
						</ul>
					</div>
				</div>
			</div>
		</div>
		
		<!-- 紧急联系人 -->
		<div id="contact" class="mui-page">
			<div class="mui-navbar-inner mui-bar mui-bar-nav">
				<button type="button" class="mui-left mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left">
					<span class="mui-icon mui-icon-left-nav"></span>个人中心
				</button>
				<h1 class="mui-center mui-title">紧急联系人</h1>
			</div>
			<div class="mui-page-content">
				<div class="mui-scroll-wrapper">
					<div class="mui-scroll">
						<ul class="mui-table-view">
							<li class="mui-table-view-cell">
								<a>联系人<input id="contactName" class="mui-pull-right rightInput" maxlength="6" placeholder="请输入紧急联系人姓名"></a>
							</li>
						</ul>
						<ul class="mui-table-view">
							<li class="mui-table-view-cell">
								<a>联系电话<input id="contactPhone" class="mui-pull-right rightInput" maxlength="11" placeholder="请输入紧急联系人电话"></a>
							</li>
						</ul>
						<ul class="mui-table-view">
							<li class="mui-table-view-cell mui-btn-primary" style="text-align: center;border-radius: 3px;">
								<a href="#" id="contactBtn">保存</a>
							</li>
						</ul>
					</div>
				</div>
			</div>
		</div>
		
		<!-- 关于人人社区 -->
		<div id="about" class="mui-page">
			<div class="mui-navbar-inner mui-bar mui-bar-nav">
				<button type="button" class="mui-left mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left">
					<span class="mui-icon mui-icon-left-nav"></span>个人中心
				</button>
				<h1 class="mui-center mui-title">关于人人社区</h1>
			</div>
			<div class="mui-page-content">
				<div class="mui-scroll-wrapper">
					<div class="mui-scroll">
						<div class="mui-content">
							<div class="mui-card">
								<ul class="mui-table-view" style="margin-top: 0; margin-bottom: 0;">
									<li class="mui-table-view-cell mui-collapse">
										<a class="mui-navigate-right" href="#">关于定位</a>
										<div class="mui-collapse-content">
											<p>
												为保证定位成功且准确，请尽量开启您手机的定位功能。
											</p>
										</div>
									</li>
									<li class="mui-table-view-cell mui-collapse">
										<a class="mui-navigate-right" href="#">关于紧急联系人</a>
										<div class="mui-collapse-content">
											<p>
												当您遇到需要救助的情况，我们可以将您的位置信息发送给您的紧急联系人，以此向您的紧急联系人发起帮助请求。
											</p>
											<p>
												请将紧急联系人设置为您亲密度较高的家人或朋友。
											</p>
										</div>
									</li>
									<li class="mui-table-view-cell mui-collapse">
										<a class="mui-navigate-right" href="#">关于权限问题</a>
										<div class="mui-collapse-content">
											<p>
												不同设备有不同的权限访问限制,请您开启人人社区定位、短信等操作。
											</p>
										</div>
									</li>
									<li class="mui-table-view-cell mui-collapse">
										<a class="mui-navigate-right" href="#">关于头像/照片上传</a>
										<div class="mui-collapse-content">
											<p>
												当您从相机/相册选取要使用的头像图片(注册时用)或您的真实照片(急救档案用)，无需保存，选取即可生效使用。
											</p>
										</div>
									</li>
									<li class="mui-table-view-cell mui-collapse">
										<a class="mui-navigate-right" href="#">关于分享位置信息</a>
										<div class="mui-collapse-content">
											<p>
												该功能仅适用于Android平台，IOS平台设备不予支持。请Andriod设备开启短信、定位等权限。
											</p>
										</div>
									</li>
								</ul>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

	</body>
	<script src="../js/mui.min.js "></script>
	<script src="../js/mui.view.js "></script>
	<script src="../js/app.js"></script>
	<script>
		mui.init();
		//初始化单页view
		var viewApi = mui('#app').view({
			defaultPage: '#setting'
		});
		//初始化单页的区域滚动
		mui('.mui-scroll-wrapper').scroll();
		//分享操作
		var shares = {};
		
		mui.plusReady(function() {
			plus.share.getServices(function(s) {
				if (s && s.length > 0) {
					for (var i = 0; i < s.length; i++) {
						var t = s[i];
						shares[t.id] = t;
					}
				}
			}, function() {
				console.log("获取分享服务列表失败");
			});
			
			//登录初始
			plus.screen.lockOrientation("portrail-primary");	//锁定屏幕方向
			var settings=app.getSettings();
			settings.logged=null;
			app.setSettings(settings);
			IsLoginThen();
			//
			defaultImg();
			setTimeout(function() {
				initImgPreview();
			}, 300);	
		});
		
// 		setTimeout(function () {
// 			
// 		},500);
		
		//注册初始化
		document.getElementById("registShowBtn").addEventListener('tap',function(){
			document.getElementById('regAccount').value="";
			document.getElementById('regPassword').value="";
			document.getElementById('regPhone').value="";
			document.getElementById('regConfirmPassword').value="";
			document.getElementById("head-img2").src = '../img/portrail_man_1.jpg';
		})
		
		//注册
		document.getElementById('regBtn').addEventListener('tap',function(){
			var regInfo = {
				account: document.getElementById('regAccount').value,
				password: document.getElementById('regPassword').value,
				phone: document.getElementById('regPhone').value
			};
			var passwordConfirm = document.getElementById('regConfirmPassword').value;
			if (passwordConfirm != regInfo.password) {
				plus.nativeUI.toast('密码两次输入不一致');
				return;
			}
			app.reg(regInfo, function(err) {
				if (err) {
					plus.nativeUI.toast(err);
					return;
				}
				plus.nativeUI.toast('注册成功');
				mui.back();
				document.getElementById('regAccount').value="";
				document.getElementById('regPassword').value="";
				document.getElementById('regPhone').value="";
			});
		});
		
		//忘记密码初始化
		document.getElementById('forgetShowBtn').addEventListener('tap',function(){
			mui('.noPhone').each(function(index,element){
				element.style.display="block";
			})
			mui('.hasPhone').each(function(index,element){
				element.style.display="none";
			})
			document.getElementById('forgetPasswordAccount').value="";
			document.getElementById('forgetRegCode').value="";
			document.getElementById('forgetNewPassword').value="";
		})
		
		//忘记密码发送验证码
		var messageTimer=null;
		mui(document.body).on('tap', '#forgetSendMessge', function(e) {
            mui(this).button('loading');
			var phone=app.getSettings().forgetPhone;
			if(!phone){
				plus.nativeUI.toast('未检测到手机号！')
            mui(this).button('reset');
				return
			}
			app.sendMessageForReg(phone,function(err){
				if(err){
					clearTimeout(messageTimer);
					mui(this).button('reset');
					plus.nativeUI.toast(err);
					return
				}
				plus.nativeUI.toast('已发送验证码，一分钟内有效！')
			})
            messageTimer=setTimeout(function() {
                mui(this).button('reset');
            }.bind(this), 60000);
			
        });
		
		//忘记密码
		document.getElementById('forgetPasswordBtn').addEventListener('tap',function(){
			var step=mui('.noPhone')[0].style.display=="none"?true:false;
			//匹配手机号阶段
			if(!step){
				var forgetAccount=document.getElementById('forgetPasswordAccount').value;
				if(!forgetAccount){
					plus.nativeUI.toast('请将以上信息填写完整')
					return
				}else{
					app.getPhone(forgetAccount,function(status,message){
						if(status){
							mui('.noPhone').each(function(index,element){
								element.style.display="none";
							})
							mui('.hasPhone').each(function(index,element){
								element.style.display="block";
							})
							var settings=app.getSettings();
							settings.forgetPhone=message.phone;
							app.setSettings(settings);
						}else{
							plus.nativeUI.toast(message)
						}
					})
				}
			}else{	//	找回密码阶段
				var regCodeState=mui('#forgetSendMessge').button().state;
				var forgetInfo={
					forgetAccount:document.getElementById('forgetPasswordAccount').value,
					regCode:document.getElementById('forgetRegCode').value,
					newPassword:document.getElementById('forgetNewPassword').value,
					phone:app.getSettings().forgetPhone
				}
				if(!forgetAccount){
					plus.nativeUI.toast('无可查询用户，请重新填入')
					mui('.noPhone').each(function(index,element){
						element.style.display="none";
					})
					mui('.hasPhone').each(function(index,element){
						element.style.display="block";
					})
					return
				}else if(!phone){
					plus.nativeUI.toast('未查询到该用户的注册手机号，请重新查询')
					mui('.noPhone').each(function(index,element){
						element.style.display="none";
					})
					mui('.hasPhone').each(function(index,element){
						element.style.display="block";
					})
					return
				}else if(!forgetInfo.regCode||!forgetInfo.newPassword){
					plus.nativeUI.toast('请将以上信息填写完整')
					return
				}else if(regCodeState=='reset'){
					plus.nativeUI.toast('验证码已过期或未发送，请重新获取！')
					return
				}else if(forgetInfo.newPassword.length<3){
					plus.nativeUI.toast('密码最短需要 3 个字符！')
					return
				}
				app.checkMessageReg(forgetInfo,function(err){
					if(err){
						plus.nativeUI.toast(err);
						return
					}
					app.changePassword(forgetInfo,function(err){
						if(err){
							plus.nativeUI.toast(err)
							return
						}
						plus.nativeUI.toast('重置密码成功')
						mui.back();
						mui('.noPhone').each(function(index,element){
							element.style.display="none";
						})
						mui('.hasPhone').each(function(index,element){
							element.style.display="block";
						})
						var settings=app.getSettings();
						settings.forgetPhone=null;
						app.setSettings(settings);
					})
				})
			}
		})
		
		//登录
		document.getElementById('loginBtn').addEventListener('tap',function(){
			var loginInfo = {
				account: document.getElementById('loginAccount').value,
				password: document.getElementById('loginPassword').value
			};
			app.login(loginInfo, function(err) {
				if (err) {
					plus.nativeUI.toast(err);
					return;
				}
				//判断是否自动登录
				var isActive=document.getElementById('autoLogin').classList.contains('mui-active');
				var settings=app.getSettings();
				settings.autoLogin=isActive;
				settings.username=loginInfo.account;
				app.setSettings(settings);
				IsLoginThen();
				mui.back();
			});
		});
		
		//退出登录
		document.getElementById('settingBtn').addEventListener('tap',function(){
			var settingBtnText=document.getElementById('settingBtn').innerText;
			if(settingBtnText=="登录"){
				document.getElementById('loginAccount').value="";
				document.getElementById('loginPassword').value="";
				return
			}
			mui.confirm('确定退出登录且不再自动登录吗？','人人社区',['取消退出','确认退出'],function (e) {
				if(e.index==0){
					return
				}else{
					app.setSettings();	//自动登录和已登录标示
					IsLoginThen()		//初始化个人中心
				}
			},'div')
		})
		
		//急救档案初始化
		document.getElementById('aidFileShowBtn').addEventListener("tap",function(){			
			//图片的初始化
			if(mui.os.plus){
				plus.io.resolveLocalFileSystemURL("_doc/aidHeadPic.jpg", function(entry) {
					var s = entry.fullPath + "?version=" + new Date().getTime();;
					document.getElementById("head-img1").src = s;	//急救档案
				}, function(e) {
					document.getElementById("head-img1").src = '../img/portrail_man_1.jpg';
				})
			}else{
				document.getElementById("head-img1").src = '../img/portrail_man_1.jpg';
			}
			var user=app.getSettings().currentUser;
			app.aidGet(user, function(status,message) {
				if (status) {
					document.getElementById('aidName').value=message.realName;
					document.getElementById('aidAddress').value=message.address;
					document.getElementById('aidCase').value=message.case;
				}
				plus.nativeUI.toast(message);
				document.getElementById('aidName').value="";
				document.getElementById('aidAddress').value="";
				document.getElementById('aidCase').value="";
			})
			
			
			
		})
		
		//急救档案的保存
		document.getElementById('aidFileBtn').addEventListener('tap',function(){
			var aidFileInfo = {
				name:document.getElementById('aidName').value,
				address:document.getElementById('aidAddress').value,
				case:document.getElementById('aidCase').value,
				uid:app.getSettings().currentUser
			};
			app.aidAdd(aidFileInfo, function(err) {
				if (err) {
					plus.nativeUI.toast(err);
					return;
				}
				plus.nativeUI.toast('保存成功');
				mui.back();
			});
		})
		
		//紧急联系人的初始化
		document.getElementById('contactShowBtn').addEventListener('tap',function(){
			var user=app.getSettings().currentUser;
			app.contactGet(user, function(status,message) {
				if (status) {
					document.getElementById('contactName').value=message.contact;
					document.getElementById('contactPhone').value=message.contactPhone;
				}
				plus.nativeUI.toast(message);
				document.getElementById('contactName').value="";
				document.getElementById('contactPhone').value="";
			})
		})
		
		//紧急联系人的保存
		document.getElementById('contactBtn').addEventListener('tap',function(){
			var contactInfo = {
				contactName:document.getElementById('contactName').value,
				contactPhone:document.getElementById('contactPhone').value,
				uid:app.getSettings().currentUser
			};
			app.contactAdd(contactInfo, function(err) {
				if (err) {
					plus.nativeUI.toast(err);
					return;
				}
				plus.nativeUI.toast('保存成功');
				mui.back();
			});
		})
		
		
		//判断是否登录,后对个人中心进行更新渲染
		var IsLoginThen=function(){
			//先判断是否有自动登录设置
			var settings=app.getSettings();
			var userName=document.getElementById('user-name');
			var showIfLoggedIn=document.getElementsByClassName('isLoggedIn');
			var settingBtn=document.getElementById('settingBtn');
			if(settings.autoLogin||settings.logged){	//有自动登录的用户或已经登录
				if(settings.currentUser){	
					//已经登录
					userName.innerText="帐号："+(settings.username||'已登录');
					settingBtn.innerText="退出登录";
					settingBtn.href="#";
					for(var i=0;i<showIfLoggedIn.length;i++){
						showIfLoggedIn[i].style.display='block';
					}	
					return
				}
			}
			//无登录
			plus.nativeUI.toast('请先行登录才能使用完整功能');
			userName.innerText="未登录";
			settingBtn.innerText="登录";
			settingBtn.href="#login";
			for(var i=0;i<showIfLoggedIn.length;i++){
				showIfLoggedIn[i].style.display='none';
			}
			app.setSettings();
		}
		
		
		var view = viewApi.view;
		(function($) {
			//处理view的后退与webview后退
			var oldBack = $.back;
			$.back = function() {
				if (viewApi.canBack()) { //如果view可以后退，则执行view的后退
					viewApi.back();
				} else { //执行webview后退
					oldBack();
				}
			};
			//监听页面切换事件方案1,通过view元素监听所有页面切换事件，目前提供pageBeforeShow|pageShow|pageBeforeBack|pageBack四种事件(before事件为动画开始前触发)
			//第一个参数为事件名称，第二个参数为事件回调，其中e.detail.page为当前页面的html对象
			view.addEventListener('pageBeforeShow', function(e) {
				//				console.log(e.detail.page.id + ' beforeShow');
			});
			view.addEventListener('pageShow', function(e) {
				//				console.log(e.detail.page.id + ' show');
			});
			view.addEventListener('pageBeforeBack', function(e) {
				//				console.log(e.detail.page.id + ' beforeBack');
			});
			view.addEventListener('pageBack', function(e) {
				//				console.log(e.detail.page.id + ' back');
			});
		})(mui);
		//更换头像
		mui(".mui-table-view-cell").on("tap", ".head-pic", function(e) {
			var ImgId=this.getAttribute("id");
			var whichImg=ImgId=="head-aid"?"aidlImg":"justImg"
			if(mui.os.plus){
				var a = [{
					title: "拍照"
				}, {
					title: "从手机相册选择"
				}];
				plus.nativeUI.actionSheet({
					title: "修改头像",
					cancel: "取消",
					buttons: a
				}, function(b) {
					switch (b.index) {
						case 0:
							break;
						case 1:
							getImage(whichImg);
							break;
						case 2:
							galleryImg(whichImg);
							break;
						default:
							break
					}
				})	
			}
			
		});

		function getImage(whichImg) {
			var imgLocalPlace=whichImg=="aidlImg"?"_doc/aidHeadPic.jpg":"_doc/head.jpg";
			var c = plus.camera.getCamera();
			c.captureImage(function(e) {
				plus.io.resolveLocalFileSystemURL(e, function(entry) {
					var s = entry.toLocalURL() + "?version=" + new Date().getTime();
					console.log(s);
					document.getElementById("head-img").src = s;
					document.getElementById("head-img1").src = s;
					//变更大图预览的src
					//目前仅有一张图片，暂时如此处理，后续需要通过标准组件实现
					document.querySelector("#__mui-imageview__group .mui-slider-item img").src = s + "?version=" + new Date().getTime();;;
				}, function(e) {
					console.log("读取拍照文件错误：" + e.message);
				});
			}, function(s) {
				console.log("error" + s);
			}, {
				filename: imgLocalPlace
			})
		}

		function galleryImg(whichImg) {
			var imgLocalPlace=whichImg=="aidlImg"?"aidHeadPic.jpg":"head.jpg";
			plus.gallery.pick(function(a) {
				plus.io.resolveLocalFileSystemURL(a, function(entry) {
					plus.io.resolveLocalFileSystemURL("_doc/", function(root) {
						root.getFile("head.jpg", {}, function(file) {
							//文件已存在
							file.remove(function() {
								console.log("file remove success");
								entry.copyTo(root, imgLocalPlace, function(e) {
										var e = e.fullPath + "?version=" + new Date().getTime();
										var whichPicId=whichImg=="aidlImg"?"head-img1":"head-img";
										document.getElementById(whichPicId).src = e;
										//变更大图预览的src
										//目前仅有一张图片，暂时如此处理，后续需要通过标准组件实现
										document.querySelector("#__mui-imageview__group .mui-slider-item img").src = e + "?version=" + new Date().getTime();;
									},
									function(e) {
										console.log('copy image fail:' + e.message);
									});
							}, function() {
								console.log("delete image fail:" + e.message);
							});
						}, function() {
							//文件不存在
							entry.copyTo(root, imgLocalPlace, function(e) {
									var path = e.fullPath + "?version=" + new Date().getTime();
									var whichPicId=whichImg=="aidlImg"?"head-img1":"head-img";
									document.getElementById(whichPicId).src = path;
									//变更大图预览的src
									//目前仅有一张图片，暂时如此处理，后续需要通过标准组件实现
									document.querySelector("#__mui-imageview__group .mui-slider-item img").src = path;
								},
								function(e) {
									console.log('copy image fail:' + e.message);
								});
						});
					}, function(e) {
						console.log("get _www folder fail");
					})
				}, function(e) {
					console.log("读取拍照文件错误：" + e.message);
				});
			}, function(a) {}, {
				filter: "image"
			})
		};

		function defaultImg() {
			//急救档案的图片初始化
			var currentUser=app.getSettings().currentUser;
			if(currentUser){
				if(mui.os.plus){
					plus.io.resolveLocalFileSystemURL("_doc/aidHeadPic.jpg", function(entry) {
						var s = entry.fullPath + "?version=" + new Date().getTime();;
						document.getElementById("head-img1").src = s;	//急救档案
					}, function(e) {
						document.getElementById("head-img1").src = '../img/portrail_man_1.jpg';
					})
				}else{
					document.getElementById("head-img1").src = '../img/portrail_man_1.jpg';
				}
			}
			//个人中心的用户头像初始化
			if(mui.os.plus){
				plus.io.resolveLocalFileSystemURL("_doc/head.jpg", function(entry) {
					var s = entry.fullPath + "?version=" + new Date().getTime();
					document.getElementById("head-img").src = s;
				}, function(e) {
					document.getElementById("head-img").src = '../img/portrail_man_1.jpg';
				})
			}else{
				document.getElementById("head-img").src = '../img/portrail_man_1.jpg';
			}
			
		}
		document.getElementById("head-img1").addEventListener('tap', function(e) {
			e.stopPropagation();
		});

		function initImgPreview() {
			var imgs = document.querySelectorAll("img.mui-action-preview");
			imgs = mui.slice.call(imgs);
			if (imgs && imgs.length > 0) {
				var slider = document.createElement("div");
				slider.setAttribute("id", "__mui-imageview__");
				slider.classList.add("mui-slider");
				slider.classList.add("mui-fullscreen");
				slider.style.display = "none";
				slider.addEventListener("tap", function() {
					slider.style.display = "none";
				});
				slider.addEventListener("touchmove", function(event) {
					event.preventDefault();
				})
				var slider_group = document.createElement("div");
				slider_group.setAttribute("id", "__mui-imageview__group");
				slider_group.classList.add("mui-slider-group");
				imgs.forEach(function(value, index, array) {
					//给图片添加点击事件，触发预览显示；
					value.addEventListener('tap', function() {
						slider.style.display = "block";
						_slider.refresh();
						_slider.gotoItem(index, 0);
					})
					var item = document.createElement("div");
					item.classList.add("mui-slider-item");
					var a = document.createElement("a");
					var img = document.createElement("img");
					img.setAttribute("src", value.src);
					a.appendChild(img)
					item.appendChild(a);
					slider_group.appendChild(item);
				});
				slider.appendChild(slider_group);
				document.body.appendChild(slider);
				var _slider = mui(slider).slider();
			}
		}

		if(mui.os.stream){
			document.getElementById("check_update").display = "none";
		}
		
	</script>

</html>